#!/usr/bin/env python
# -*- encoding: utf-8 -*-
import subprocess
import optparse
import re
import random
import string

def change_mac(iface, new_mac):
    print("Changing mac address to {}".format(new_mac))
    subprocess.call(["ifconfig", iface, "down"])
    subprocess.call(["ifconfig", iface, "hw", "ether", new_mac])
    subprocess.call(["ifconfig", iface, "up"])

def get_options():
    parser = optparse.OptionParser()
    parser.add_option("-m", "--mac", dest="new_mac", help="specify new_mac")
    parser.add_option("-i", "--iface", dest="iface",
                      help="Specify a interface to change its mac address")
    parser.add_option("-r", "--random",
                      action="store_true", dest="random", default=False,
                      help="Generate random mac address")

    options, arguments = parser.parse_args()

    if not options.interface:
        parser.error("Enter an interface.")
    elif not options.new_mac and not options.random:
        parser.error("Enter a new mac address or add -r for random mac.")
    elif options.new_mac and options.random:
        parser.error("--mac and --random should not be used together.")
    return options

def get_current_mac(iface):
    ifconfig_result = subprocess.check_output(["ifconfig", iface])

    current_mac = re.search(r"\w\w:{5}\w\w", ifconfig_result)
    if current_mac:
        return current_mac.group(0)
    else:
        print("Couldn't read ifconfig")
        return None

def get_random_mac():
    # a1:a2:a3:4a:6a:7a
    mac = ""
    for a in range(6):
        num = random.randint(0,9)
        letter = random.choice("abcdef")
        mac += "{}{}:".format(letter, num)

    return mac[:-1]


options = get_options()

iface = options.iface
mac = options.new_mac

if not mac and options.random:
    mac = get_random_mac()

change_mac(options.iface, options.new_mac)
current_mac = get_current_mac(options.iface)


if current_mac and current_mac[:len(options.new_mac)] == options.new_mac:
    print("Mac address changed to " + current_mac)
else:
    print("Mac address didn't change")